<html>
<body>
<script>

var appStorage = (function(key_value_json, operation, callback) {

	var json = key_value_json;
	var key = key_value_json.key
	var val = key_value_json.value || "";

	function isChromeApp() {
		var res = false;
		if(chrome != undefined) {
           if(chrome.app.window != undefined) {
             // 「chrome アプリ」である
             res = true;
           }
        }
		return res;
	}
    
    function chromeApp() {
        var storageArea = chrome.storage.local;
        
    }

    function browser() {
    	if(typeof val == "object" || typeof val == "number") {
           val = JSON.stringify(val);
           val = val + "1";
	    }else {
		   val = val + "0";
	    }

        switch(operation) {
        	case "set": 
        	     localStorage.setItem(key, val);
        	     transactionCompleted(json);
        	     break;
        	case "get": 
        	     var v = localStorage.getItem(key);
        	     if(v != undefined) {
        	        var checkDigit = +(v[v.length - 1]);
        	        var v = v.slice(0, -1);
        	        if(checkDigit == 1) {
                        v = JSON.parse(v);
        	        }
        	     }
        	     transactionCompleted({"key": key, "value": v});
        	     break;
            case "remove":
                 localStorage.removeItem(key);
                 transactionCompleted(json);
                 break;

            default: break;
        }
    }

    function transactionCompleted(j) {
        console.group("["+operation+"] transaction completed.");
        console.dirxml(j);
        if(callback != undefined) {
        	console.groupEnd("["+operation+"] transaction completed.");
            callback(j);
        }else {
            console.info("'callback' does not exist.");
            console.groupEnd("["+operation+"] transaction completed.");
        }
    }

    function main() {
    	if(isChromeApp() == true) {
            chromeApp();
    	}else {
    		browser();
    	}
    }
 
    main();
    //transactionCompleted();
    return null;
});
</script>
</body>